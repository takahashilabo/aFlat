# 見開きページスキャナー (Book Scanner)

本の見開きページを撮影した画像から、左右のページを個別に切り出してPDFファイルを作成するPythonアプリケーションです。

## 機能

- 📚 見開き画像から左右のページを自動切り出し
- 🎯 最初の画像で一度だけ左右の領域を指定（4点×2 = 計8クリック）
- 📐 ホモグラフィ変換で透視補正
- 🔄 以降の画像は同じ領域情報で自動処理
- 📄 複数の画像を1つのPDFファイルに変換
- 🚀 わかりやすいPythonコード

## 必要要件

- Python 3.12以上
- uv（Pythonパッケージマネージャー）

## セットアップ

### 1. uvのインストール（まだの場合）

macOSの場合:
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### 2. 依存パッケージのインストール

プロジェクトディレクトリで以下を実行:
```bash
uv sync
```

これにより、以下のパッケージが自動的にインストールされます:
- opencv-python（画像処理）
- Pillow（PDF作成）
- numpy（数値計算）

## 使い方

### 基本的な使い方

```bash
uv run python book_scanner.py <画像フォルダのパス>
```

### オプション

```bash
uv run python book_scanner.py <画像フォルダのパス> [オプション]

オプション:
  -o, --output <ファイル名>  出力PDFファイル名（デフォルト: output.pdf）
  -h, --help                ヘルプを表示
```

### 使用例

```bash
# 基本的な使い方
uv run python book_scanner.py ./images

# 出力ファイル名を指定
uv run python book_scanner.py ./images -o my_book.pdf
```

## 操作手順

### 1. 画像の準備
- 本の見開きページを撮影した画像を1つのフォルダにまとめます
- 対応フォーマット: JPG, JPEG, PNG, BMP, TIFF

### 2. プログラムの実行
- コマンドラインで上記のコマンドを実行します

### 3. 最初の画像でページ領域を指定
**最初の1枚だけ**領域を指定します（計8クリック）：

#### 1️⃣ 左ページの4点を指定
1. ウィンドウ「左ページの選択」が開きます
2. ページの4つの角を **左上→右上→右下→左下** の順にクリック
3. **Enterキー** で確定（Rキーでリセット）

#### 2️⃣ 右ページの4点を指定
1. 同様に「右ページの選択」で4点を指定
2. **Enterキー** で確定

### 4. 自動処理
- 2枚目以降の画像は、最初に指定した領域情報を使って自動的に処理されます
- 各画像から同じ位置の左右ページが切り出されます

### 5. PDF出力
- すべての画像を処理した後、指定したPDFファイルが生成されます
- ページは左ページ→右ページの順で並びます

## プログラムの構造

```
book_scanner.py
├── PagePointSelector クラス
│   └── 画像上で4点を選択するGUI機能
├── perspective_transform_page 関数
│   └── ホモグラフィ変換で透視補正
├── get_page_regions 関数
│   └── 最初の画像から左右の領域（4点ずつ）を取得
├── process_spread_image_with_regions 関数
│   └── 指定された領域で見開き画像を処理（ホモグラフィ変換）
└── process_all_images 関数
    └── 全画像を処理してPDFを作成
```

## 技術詳細

### ホモグラフィ変換（透視補正）
ユーザーが指定した4点を基準に、ページを矩形に補正します：

```python
# 4点からホモグラフィ行列を計算
perspective_matrix = cv2.getPerspectiveTransform(
    np.float32(src_points),
    np.float32([(0, 0), (page_width, 0), (page_width, page_height), (0, page_height)])
)

# ホモグラフィ変換を適用
result = cv2.warpPerspective(image, perspective_matrix, (page_width, page_height))
```

### 処理フロー
1. 最初の画像を読み込み
2. 表示用にリサイズ（画面に収まるサイズ）
3. ユーザーが左右のページの4点を指定
4. 元の画像サイズに合わせて座標をスケール
5. 2枚目以降の画像では、同じ座標を使ってホモグラフィ変換で補正
6. すべてのページをPDFに結合

## トラブルシューティング

### 画像が読み込めない
- 画像ファイルが破損していないか確認してください
- 対応フォーマット（JPG, PNG等）であることを確認してください

### ウィンドウが表示されない
- OpenCVのGUI機能が正しく動作する環境か確認してください
- macOSの場合、XQuartzなどのX11サーバーが必要な場合があります

### PDFが作成されない
- 少なくとも1つの画像が正常に処理されているか確認してください
- 出力先フォルダの書き込み権限を確認してください

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 今後の改善案

- [ ] 自動ページ検出機能の追加
- [ ] 自動輪郭線検出（エッジ検出ベース）
- [ ] 領域情報の保存・読み込み機能
- [ ] プレビュー機能
- [ ] 画質調整オプション
- [ ] より高度な透視補正
